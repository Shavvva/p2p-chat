<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            height: 100vh;
            background: #0a0a0a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        /* Модальное окно авторизации */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .auth-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #333;
        }
        
        .auth-content h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
        }
        
        .auth-button {
            width: 100%;
            padding: 12px;
            background: #3390ec;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .auth-button:hover {
            background: #2a7bd8;
        }
        
        .auth-button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        .checking-message {
            color: #00ff88;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        /* Основной интерфейс */
        header {
            background: #1a1a1a;
            color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        /* Стиль хедера при активном поиске */
        header.search-active {
            padding: 5px 20px;
            height: 60px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        /* Скрываем левую часть при поиске */
        .search-active .header-left:not(.search-header-left) {
            display: none;
        }
        
        .search-header-left {
            display: none;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .search-active .search-header-left {
            display: flex;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        /* Скрываем правую часть при поиске */
        .search-active .header-right:not(.search-controls) {
            display: none;
        }
        
        .search-controls {
            display: none;
            align-items: center;
            gap: 12px;
            margin-left: 8px;
        }
        
        .search-active .search-controls {
            display: flex;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3390ec;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        /* Telegram стиль для кнопок */
        .tg-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            color: #a0a0a0;
        }
        
        .tg-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        
        .tg-btn:active {
            transform: scale(0.95);
        }
        
        .tg-btn.active {
            color: #3390ec;
            background: rgba(51, 144, 236, 0.1);
        }
        
        /* Размеры SVG иконок */
        .tg-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tg-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
            stroke: currentColor;
            stroke-width: 0;
        }
        
        /* Иконка стрелки назад */
        .back-icon {
            width: 20px;
            height: 20px;
            position: relative;
        }
        
        .back-icon::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            width: 10px;
            height: 2px;
            background: currentColor;
            transform: translateY(-50%);
        }
        
        .back-icon::after {
            content: '';
            position: absolute;
            left: 2px;
            top: 50%;
            width: 6px;
            height: 6px;
            border-left: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: translateY(-50%) rotate(45deg);
        }
        
        /* Поле поиска в хедере */
        .search-input-wrapper {
            flex: 1;
            display: none;
        }
        
        .search-active .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #2d2d2d;
            border-radius: 20px;
            background: #2a2a2a;
            color: white;
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.2s;
            height: 40px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3390ec;
            box-shadow: 0 0 0 2px rgba(51, 144, 236, 0.2);
        }
        
        .close-search {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 5px;
        }
        
        .close-search:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }
        
        .search-results-info {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(51, 144, 236, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 98;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.2s ease;
        }
        
        .search-results-info.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .search-nav {
            display: flex;
            gap: 8px;
        }
        
        .search-nav-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            opacity: 0.8;
            flex-shrink: 0;
        }
        
        .search-nav-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            opacity: 1;
        }
        
        .search-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Панель закрепленного сообщения (под хедером, как в Telegram) */
        .pinned-message-panel {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: rgba(42, 42, 42, 0.95);
            border-bottom: 1px solid #333;
            z-index: 99;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            padding: 8px 15px;
            animation: slideDown 0.3s ease;
            height: 52px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pinned-message-panel.active {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .pinned-message-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }
        
        .pinned-message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            flex-shrink: 0;
            color: white;
        }
        
        .pinned-message-info {
            flex: 1;
            min-width: 0;
        }
        
        .pinned-message-title {
            font-size: 12px;
            font-weight: 500;
            color: #a0a0a0;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pinned-message-text {
            font-size: 13px;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 400;
        }
        
        .unpin-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #888;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .unpin-btn:hover {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
        }
        
        /* Стиль для закрепленного сообщения в чате */
        .message.pinned {
            border-left: 3px solid #3390ec;
            position: relative;
        }
        
        .message.pinned::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #3390ec;
            border-radius: 3px 0 0 3px;
        }
        
        .pin-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            color: #3390ec;
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Разделители дат */
        .date-divider {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            opacity: 0.8;
        }

        .date-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #333 15%, #333 85%, transparent 100%);
        }

        .date-label {
            position: relative;
            background: #2a2a2a;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #a0a0a0;
            border: 1px solid #333;
            z-index: 1;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }
        
        .container.with-pinned {
            margin-top: 112px; /* 60px хедер + 52px панель закрепленного сообщения */
            height: calc(100vh - 112px);
        }
        
        .sidebar {
            width: 250px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        /* Скрытый сайдбар на ПК */
        .sidebar.hidden {
            transform: translateX(-100%);
            width: 0;
            border-right: none;
            padding: 0;
            overflow: hidden;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: calc(100% - 70px);
        }
        
        .message-container {
            display: flex;
            align-items: flex-end;
            max-width: 100%;
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        .message-container.deleting {
            opacity: 0.5;
        }
        
        .message-container.search-highlight {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            animation: highlightPulse 2s ease-in-out;
        }
        
        .message-container.search-current {
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.5);
        }
        
        @keyframes highlightPulse {
            0% { background: rgba(255, 215, 0, 0.1); }
            50% { background: rgba(255, 215, 0, 0.3); }
            100% { background: rgba(255, 215, 0, 0.1); }
        }
        
        .message-container.my {
            justify-content: flex-end;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
            margin-bottom: 5px;
            color: white;
        }
        
        .message-container.my .message-avatar {
            margin-left: 10px;
            margin-right: 0;
        }
        
        .message-container.other .message-avatar {
            margin-right: 10px;
            margin-left: 0;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            min-width: 120px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .message:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .message-container.my .message {
            background: #3390ec;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-container.my .message:hover {
            background: #2a7bd8;
        }
        
        .message-container.other .message {
            background: #2a2a2a;
            border-bottom-left-radius: 5px;
        }
        
        .message.editing {
            background: rgba(51, 144, 236, 0.3) !important;
            border: 1px solid #3390ec !important;
        }
        
        .message .search-match {
            background: rgba(255, 204, 0, 0.4);
            padding: 1px 3px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        /* Реакции на сообщения */
        .reactions {
            display: none; /* Скрываем по умолчанию */
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
            align-items: center;
            min-height: 24px;
        }

        /* Показываем только когда есть реакции */
        .reactions:not(:empty) {
            display: flex;
            animation: reactionsAppear 0.2s ease-out;
        }

        /* Анимация появления реакций */
        @keyframes reactionsAppear {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .reaction {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            user-select: none;
        }
        
        .reaction:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .reaction.my-reaction {
            background: rgba(51, 144, 236, 0.2);
            border-color: rgba(51, 144, 236, 0.4);
        }
        
        .reaction-emoji {
            font-size: 13px;
        }
        
        .reaction-count {
            font-size: 11px;
            color: #cccccc;
        }
        
        .reaction.my-reaction .reaction-count {
            color: #66b3ff;
        }
        
        /* Анимация добавления реакции */
        @keyframes reactionBounce {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .reaction-added {
            animation: reactionBounce 0.3s ease-out;
        }
        
        /* Блок ответа на сообщение */
        .reply-block {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #3390ec;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 100%;
            overflow: hidden;
        }
        
        .reply-sender {
            font-weight: bold;
            color: #66b3ff;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reply-text {
            color: #cccccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .close-reply {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-reply:hover {
            color: #ff4444;
        }
        
        /* Иконка ответа в блоке ответа */
        .reply-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .reply-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        
        /* Индикатор ответа в поле ввода */
        .reply-indicator {
            position: absolute;
            top: -35px;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border-bottom: 1px solid #333;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }
        
        .reply-indicator-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            overflow: hidden;
        }
        
        .reply-indicator-text {
            font-size: 12px;
            color: #66b3ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .cancel-reply {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .cancel-reply:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ff4444;
        }
        
        .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .text { 
            font-size: 14px; 
            line-height: 1.4;
        }
        
        /* Стили для ссылок */
        .text a {
            color: #66b3ff;
            text-decoration: underline;
            word-break: break-all;
            cursor: pointer !important;
            pointer-events: auto !important;
        }
        
        .message-container.my .text a {
            color: #b3d9ff;
            text-decoration: underline;
        }
        
        .text a:hover {
            color: #99ccff;
            text-decoration: none;
        }
        
        .message-container.my .text a:hover {
            color: #cce6ff;
        }
        
        /* Стили для смайликов в тексте */
        .emoji {
            font-size: 18px;
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
        }
        
        .time { 
            font-size: 11px; 
            text-align: right;
            margin-top: 8px;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edited-badge {
            font-size: 10px;
            opacity: 0.7;
            color: #a0a0a0;
        }
        
        /* Индикаторы отправки сообщений (галочки) */
        .message-status {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: 4px;
        }
        
        .status-icon {
            font-size: 13px;
            line-height: 1;
        }
        
        .status-check {
            color: #a0a0a0;
        }
        
        .status-check.delivered {
            color: #3390ec;
        }
        
        .status-check.read {
            color: #3390ec;
        }
        
        .double-check {
            position: relative;
        }
        
        .double-check::after {
            content: '';
            position: absolute;
            left: 1px;
            top: 0;
            font-size: 13px;
        }
        
        /* Меню действий для сообщения */
        .message-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 160px;
            overflow: hidden;
            display: none;
            animation: menuAppear 0.2s ease;
        }
        
        @keyframes menuAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .message-menu.active {
            display: block;
        }
        
        .message-menu-item {
            padding: 12px 16px;
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        
        .message-menu-item:hover {
            background: #3a3a3a;
        }
        
        /* Все пункты меню теперь белым цветом */
        .message-menu-item.reply,
        .message-menu-item.edit,
        .message-menu-item.delete,
        .message-menu-item.pin,
        .message-menu-item.unpin {
            color: #e0e0e0;
        }
        
        .menu-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .menu-item-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        
        /* Режим редактирования */
        .edit-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            line-height: 1.4;
            padding: 0;
            outline: none;
            font-family: inherit;
            resize: none;
            overflow: hidden;
        }
        
        .message-container.my .edit-input {
            color: white;
        }
        
        .message-container.other .edit-input {
            color: #e0e0e0;
        }
        
        .edit-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        
        .edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .save-btn {
            background: #00cc66;
            color: white;
        }
        
        .save-btn:hover {
            background: #00aa55;
        }
        
        .cancel-btn {
            background: #ff4444;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #cc3333;
        }
        
        .input-area {
            background: #1a1a1a;
            border-top: 1px solid #333;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
            height: 70px;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #333;
            border-radius: 20px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
            font-family: inherit;
        }
        
        /* Иконка смайлика */
        .emoji-toggle {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            z-index: 10;
            color: #a0a0a0;
            transition: color 0.2s;
            border-radius: 50%;
        }
        
        .emoji-toggle:hover {
            color: #3390ec;
        }
        
        .emoji-toggle.active {
            color: #3390ec;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 15px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 15px;
            padding: 15px;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            width: 260px;
            z-index: 200;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            animation: emojiPickerAppear 0.2s ease;
        }
        
        @keyframes emojiPickerAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .emoji-picker.active {
            display: flex;
        }
        
        .emoji-picker::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 16px;
            height: 16px;
            background: #2a2a2a;
            border-right: 1px solid #333;
            border-bottom: 1px solid #333;
            transform: rotate(45deg);
        }
        
        .emoji-item {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            background: transparent;
        }
        
        .emoji-item:hover {
            background: #3a3a3a;
            transform: scale(1.15);
        }
        
        .send-icon {
            background: #3390ec;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        
        .send-icon:hover {
            background: #2a7bd8;
        }
        
        .send-icon:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        h2 {
            margin-bottom: 15px;
            color: white;
            font-size: 18px;
        }
        
        .user-list { 
            list-style: none; 
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .user-item {
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-item.you {
            background: rgba(51, 144, 236, 0.2);
            border: 1px solid rgba(51, 144, 236, 0.3);
        }
        
        .user-name { 
            font-size: 14px;
            font-weight: bold;
            flex: 1;
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3390ec;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        
        /* ПАНЕЛЬ ВЫБОРА РЕАКЦИЙ */
        .reactions-panel {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            max-width: 280px;
            animation: reactionsPanelAppear 0.2s ease-out;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        @keyframes reactionsPanelAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .reactions-panel.active {
            display: flex;
        }
        
        .reaction-option {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
            background: transparent;
            border: none;
            position: relative;
        }
        
        .reaction-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.15);
        }
        
        .reaction-option:active {
            transform: scale(0.95);
        }
        
        .reaction-option.my-reaction-option {
            background: rgba(51, 144, 236, 0.2);
            border: 1px solid rgba(51, 144, 236, 0.4);
        }
        
        .reaction-option .reaction-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 5px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            pointer-events: none;
        }
        
        .reaction-option:hover .reaction-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Подложка для закрытия панели реакций */
        .reactions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 1999;
            display: none;
        }
        
        .reactions-overlay.active {
            display: block;
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
        }
        
        /* Адаптация для мобильных */
        @media (max-width: 768px) {
            .tg-btn {
                width: 36px;
                height: 36px;
            }
            
            .tg-icon {
                width: 18px;
                height: 18px;
            }
            
            .search-input-wrapper {
                margin-right: 8px;
            }
            
            .search-controls {
                gap: 6px;
                margin-left: 6px;
            }
            
            .close-search {
                margin-right: 3px;
            }
            
            .container {
                margin-top: 60px;
                height: calc(100vh - 60px);
            }
            
            .container.with-pinned {
                margin-top: 112px;
                height: calc(100vh - 112px);
            }
            
            .sidebar {
                position: fixed;
                top: 60px;
                left: 0;
                bottom: 0;
                width: 280px;
                transform: translateX(-100%);
                z-index: 90;
                height: calc(100vh - 60px);
            }
            
            .container.with-pinned .sidebar {
                top: 112px;
                height: calc(100vh - 112px);
            }
            
            .sidebar.active { transform: translateX(0); }
            .sidebar.hidden { 
                transform: translateX(-100%); 
                width: 280px; 
            }
            
            .mobile-overlay.active { display: block; z-index: 80; }
            
            .chat-area { 
                width: 100%;
                height: 100%;
            }
            
            .messages { 
                height: calc(100% - 70px);
                padding: 15px;
                padding-bottom: 20px;
                gap: 12px;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Панель закрепленного сообщения на мобильных */
            .pinned-message-panel {
                top: 60px;
                padding: 8px 12px;
                height: 52px;
            }
            
            .input-area {
                position: relative;
                height: 70px;
            }
            
            .reply-indicator {
                top: -40px;
                padding: 6px 12px;
            }
            
            .search-results-info {
                top: 112px; /* Учитываем панель закрепленного сообщения */
                font-size: 12px;
                padding: 8px 16px;
            }
            
            .container.with-pinned .search-results-info {
                top: 112px;
            }
            
            .search-input {
                height: 38px;
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .close-search {
                width: 34px;
                height: 34px;
                font-size: 16px;
            }
            
            .search-nav-btn {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .emoji-picker {
                bottom: 70px;
                left: 15px;
                right: 15px;
                width: auto;
                max-width: calc(100% - 30px);
            }
            
            .emoji-picker::after {
                left: 20px;
            }
            
            .reaction {
                padding: 1px 5px;
                font-size: 11px;
            }
            
            .reaction-emoji {
                font-size: 12px;
            }
            
            .reaction-count {
                font-size: 10px;
            }
            
            .send-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .message {
                max-width: 75%;
            }
            
            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .user-avatar-small {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            /* Панель реакций на мобильных */
            .reactions-panel {
                max-width: 90%;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                justify-content: center;
            }
            
            .reaction-option {
                width: 42px;
                height: 42px;
                font-size: 24px;
            }
            
            /* Улучшенные ссылки на мобильных */
            .text a {
                word-break: break-word;
                hyphens: auto;
            }
            
            /* На мобильных меню по долгому тапу */
            .message {
                -webkit-tap-highlight-color: transparent;
            }
            
            .message-menu {
                min-width: 140px;
            }
            
            .reply-block {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .header-right {
                gap: 10px;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Цвета для аватарок */
        .avatar-color-0 { background: #FF6B6B !important; }
        .avatar-color-1 { background: #4ECDC4 !important; }
        .avatar-color-2 { background: #FFD166 !important; }
        .avatar-color-3 { background: #06D6A0 !important; }
        .avatar-color-4 { background: #118AB2 !important; }
        .avatar-color-5 { background: #EF476F !important; }
        .avatar-color-6 { background: #7B68EE !important; }
        .avatar-color-7 { background: #20B2AA !important; }
        .avatar-color-8 { background: #FF8C00 !important; }
        .avatar-color-9 { background: #9B59B6 !important; }
        
        /* Подложка для закрытия меню */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 999;
            display: none;
        }
        
        .menu-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Модальное окно авторизации -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-content">
            <h2>Вход в чат</h2>
            <input type="text" 
                   class="auth-input" 
                   id="username-input" 
                   placeholder="Введите ваше имя"
                   maxlength="20"
                   autocomplete="off">
            <button class="auth-button" id="auth-button" disabled>Проверка...</button>
            <div class="error-message" id="error-message">
                Имя должно содержать от 2 до 20 символов
            </div>
            <div class="checking-message" id="checking-message">
                Проверка имени...
            </div>
        </div>
    </div>
    
    <!-- Основной интерфейс -->
    <header class="hidden" id="main-header">
        <div class="header-left">
            <button class="tg-btn" id="menu-toggle" title="Меню">
                <div class="tg-icon">
                    <!-- SVG иконка гамбургер-меню как в Telegram -->
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </div>
            </button>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">?</div>
                <span id="current-username">Гость</span>
            </div>
        </div>
        
        <div class="search-header-left">
            <button class="close-search" id="close-search">
                <div class="back-icon"></div>
            </button>
            <div class="search-input-wrapper">
                <input type="text" 
                       class="search-input" 
                       id="search-input" 
                       placeholder="Поиск в чате..."
                       autocomplete="off">
            </div>
        </div>
        
        <div class="header-right">
            <button class="tg-btn" id="search-toggle" title="Поиск">
                <div class="tg-icon">
                    <!-- SVG иконка поиска как в Telegram -->
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </div>
            </button>
        </div>
        
        <div class="search-controls">
            <div class="search-nav">
                <button class="search-nav-btn" id="search-prev" title="Предыдущий результат">
                    <div class="tg-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </div>
                </button>
                <button class="search-nav-btn" id="search-next" title="Следующий результат">
                    <div class="tg-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Панель закрепленного сообщения (как в Telegram) -->
    <div class="pinned-message-panel hidden" id="pinned-message-panel">
        <div class="pinned-message-content" id="pinned-message-content">
            <div class="pinned-message-avatar" id="pinned-message-avatar"></div>
            <div class="pinned-message-info">
                <div class="pinned-message-title">
                    <div class="tg-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
                        </svg>
                    </div>
                    <span>Закрепленное сообщение</span>
                </div>
                <div class="pinned-message-text" id="pinned-message-text"></div>
            </div>
        </div>
        <button class="unpin-btn" id="unpin-btn" title="Открепить">
            <div class="tg-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </div>
        </button>
    </div>
    
    <!-- Информация о результатах поиска -->
    <div class="search-results-info" id="search-results-info">
        <span id="search-results-text"></span>
    </div>
    
    <!-- Подложка для закрытия меню -->
    <div class="menu-overlay" id="menu-overlay"></div>
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Подложка для закрытия панели реакций -->
    <div class="reactions-overlay" id="reactions-overlay"></div>
    
    <div class="container hidden" id="main-container">
        <aside class="sidebar" id="sidebar">
            <h2>Участники (<span id="online-count">0</span>)</h2>
            <ul class="user-list" id="user-list"></ul>
        </aside>
        
        <main class="chat-area">
            <div class="messages" id="messages-container">
                <!-- Сообщения с разделителями дат будут добавлены через JavaScript -->
                <div class="date-divider today">
                    <div class="date-label">Сегодня</div>
                </div>
                <div class="message-container other">
                    <div class="message-avatar other avatar-color-0">С</div>
                    <div class="message other">
                        <div class="sender">Система</div>
                        <div class="text">Добро пожаловать в чат! Нажмите на иконку ☺ чтобы открыть панель эмодзи. Нажмите на сообщение, чтобы открыть меню или выбрать реакцию. Нажмите на сообщение один раз, чтобы поставить случайную реакцию, или дважды, чтобы выбрать реакцию из меню. Используйте поиск 🔍 для быстрого нахождения сообщений.</div>
                        <div class="time">12:00</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <!-- Индикатор ответа -->
                <div class="reply-indicator hidden" id="reply-indicator">
                    <div class="reply-indicator-info">
                        <span style="color: #66b3ff; font-size: 12px;">
                            <div class="tg-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/>
                                </svg>
                            </div>
                        </span>
                        <div class="reply-indicator-text" id="reply-indicator-text">Ответ на сообщение</div>
                    </div>
                    <button class="cancel-reply" id="cancel-reply">
                        <div class="tg-icon">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </div>
                    </button>
                </div>
                
                <div class="input-wrapper">
                    <button class="emoji-toggle" id="emoji-toggle" type="button" title="Эмодзи">
                        <div class="tg-icon">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                            </svg>
                        </div>
                    </button>
                    <input type="text" id="message-input" placeholder="Сообщение или ссылка...">
                    <div class="emoji-picker" id="emoji-picker">
                        <!-- Эмодзи будут добавлены через JavaScript -->
                    </div>
                </div>
                <button class="send-icon" id="send-btn" title="Отправить" type="button">
                    <div class="tg-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </main>
    </div>

    <!-- Контекстное меню для сообщений -->
    <div class="message-menu" id="message-menu">
        <button class="message-menu-item" id="menu-reply">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/>
                </svg>
            </span>
            <span>Ответить</span>
        </button>
        <button class="message-menu-item" id="menu-react">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-4c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm8-6c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2z"/>
                </svg>
            </span>
            <span>Добавить реакцию</span>
        </button>
        <button class="message-menu-item" id="menu-pin">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
                </svg>
            </span>
            <span>Закрепить</span>
        </button>
        <button class="message-menu-item" id="menu-unpin" style="display: none;">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 9V4h1V2H7v2h1v5l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2zm-2 2h-4V4h4v7z"/>
                </svg>
            </span>
            <span>Открепить</span>
        </button>
        <button class="message-menu-item" id="menu-edit">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </span>
            <span>Редактировать</span>
        </button>
        <button class="message-menu-item" id="menu-delete">
            <span class="menu-item-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </span>
            <span>Удалить</span>
        </button>
    </div>
    
    <!-- Панель выбора реакций -->
    <div class="reactions-panel" id="reactions-panel">
        <!-- Реакции будут добавлены через JavaScript -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            databaseURL: "https://chat-c54e2-default-rtdb.europe-west1.firebasedatabase.app/"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let userId = '';
        let userName = '';
        let nameCheckTimeout = null;
        let currentNameCheck = '';
        let editingMessageId = null;
        let activeMessageMenu = null;
        let replyingToMessage = null;
        let searchResults = [];
        let currentSearchIndex = -1;
        let isSearchActive = false;
        let searchQuery = '';
        let lastTapTime = 0;
        let tapTimeout = null;
        let lastTappedMessage = null;
        let isSidebarVisible = true;
        let currentReactionPanelMessageId = null;
        
        // Элементы DOM
        const authModal = document.getElementById('auth-modal');
        const usernameInput = document.getElementById('username-input');
        const authButton = document.getElementById('auth-button');
        const errorMessage = document.getElementById('error-message');
        const checkingMessage = document.getElementById('checking-message');
        const mainHeader = document.getElementById('main-header');
        const mainContainer = document.getElementById('main-container');
        const userAvatar = document.getElementById('user-avatar');
        const currentUsername = document.getElementById('current-username');
        const searchToggle = document.getElementById('search-toggle');
        const searchInput = document.getElementById('search-input');
        const closeSearch = document.getElementById('close-search');
        const searchPrev = document.getElementById('search-prev');
        const searchNext = document.getElementById('search-next');
        const searchResultsInfo = document.getElementById('search-results-info');
        const searchResultsText = document.getElementById('search-results-text');
        const menuToggle = document.getElementById('menu-toggle');
        const reactionsPanel = document.getElementById('reactions-panel');
        const reactionsOverlay = document.getElementById('reactions-overlay');
        const pinnedMessagePanel = document.getElementById('pinned-message-panel');
        const pinnedMessageContent = document.getElementById('pinned-message-content');
        const pinnedMessageAvatar = document.getElementById('pinned-message-avatar');
        const pinnedMessageText = document.getElementById('pinned-message-text');
        const unpinBtn = document.getElementById('unpin-btn');
        
        const messagesRef = database.ref('messages');
        const messageStatusRef = database.ref('messageStatus');
        const reactionsRef = database.ref('reactions');
        const pinnedMessageRef = database.ref('pinnedMessage'); // Теперь только одно сообщение
        const onlineUsersRef = database.ref('onlineUsers');
        let currentUserRef = null;
        
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const userList = document.getElementById('user-list');
        const onlineCount = document.getElementById('online-count');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const menuOverlay = document.getElementById('menu-overlay');
        const emojiToggle = document.getElementById('emoji-toggle');
        const emojiPicker = document.getElementById('emoji-picker');
        const messageMenu = document.getElementById('message-menu');
        const menuReplyBtn = document.getElementById('menu-reply');
        const menuReactBtn = document.getElementById('menu-react');
        const menuPinBtn = document.getElementById('menu-pin');
        const menuUnpinBtn = document.getElementById('menu-unpin');
        const menuEditBtn = document.getElementById('menu-edit');
        const menuDeleteBtn = document.getElementById('menu-delete');
        const replyIndicator = document.getElementById('reply-indicator');
        const replyIndicatorText = document.getElementById('reply-indicator-text');
        const cancelReplyBtn = document.getElementById('cancel-reply');
        
        let isMenuOpen = false;
        let isEmojiPickerOpen = false;
        let isReactionsPanelOpen = false;
        let currentContextMessage = null;
        let messagesMap = new Map();
        let reactionsMap = new Map();
        let messageStatusMap = new Map();
        let currentPinnedMessage = null;
        
        // Мапы для хранения сообщений по датам и разделителей
        let messagesByDate = new Map();
        let dateDividers = new Map();
        
        // Набор эмодзи для панели
        const emojis = [
            { emoji: '😊', name: 'Улыбка' },
            { emoji: '😂', name: 'Смех' },
            { emoji: '❤️', name: 'Сердце' },
            { emoji: '🔥', name: 'Огонь' },
            { emoji: '👍', name: 'Палец вверх' },
            { emoji: '🎉', name: 'Праздник' },
            { emoji: '🙏', name: 'Спасибо' },
            { emoji: '😢', name: 'Плач' },
            { emoji: '🤔', name: 'Размышление' },
            { emoji: '😎', name: 'Круто' },
            { emoji: '😍', name: 'Влюбленный' },
            { emoji: '🥳', name: 'Тусовщик' },
            { emoji: '😘', name: 'Воздушный поцелуй' },
            { emoji: '✨', name: 'Блестки' }
        ];
        
        // Реакции для быстрого доступа (как в Telegram)
        const quickReactions = [
            { emoji: '👍', name: 'Палец вверх' },
            { emoji: '👎', name: 'Палец вниз' },
            { emoji: '❤️', name: 'Сердце' },
            { emoji: '🔥', name: 'Огонь' },
            { emoji: '🥰', name: 'Влюбленное лицо' },
            { emoji: '😍', name: 'Влюбленный' },
            { emoji: '🤩', name: 'Звездные глаза' },
            { emoji: '😊', name: 'Улыбка' },
            { emoji: '😂', name: 'Смех' },
            { emoji: '🤣', name: 'Катаюсь со смеху' },
            { emoji: '😎', name: 'Круто' },
            { emoji: '🥳', name: 'Тусовщик' },
            { emoji: '😢', name: 'Плач' },
            { emoji: '😭', name: 'Громкий плач' },
            { emoji: '🤔', name: 'Размышление' },
            { emoji: '🎉', name: 'Праздник' },
            { emoji: '✨', name: 'Блестки' },
            { emoji: '🙏', name: 'Спасибо' }
        ];
        
        // Хранилище онлайн пользователей
        let onlineUsersMap = new Map();
        
        // Функция для форматирования даты как в Telegram
        function formatDateDivider(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const isToday = date.getDate() === today.getDate() && 
                           date.getMonth() === today.getMonth() && 
                           date.getFullYear() === today.getFullYear();
            const isYesterday = date.getDate() === yesterday.getDate() && 
                               date.getMonth() === yesterday.getMonth() && 
                               date.getFullYear() === yesterday.getFullYear();
            
            if (isToday) {
                return { dateKey: date.toDateString(), label: "Сегодня", className: "today" };
            } else if (isYesterday) {
                return { dateKey: date.toDateString(), label: "Вчера", className: "yesterday" };
            } else {
                const months = [
                    'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                    'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
                ];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                const currentYear = new Date().getFullYear();
                if (year === currentYear) {
                    return { dateKey: date.toDateString(), label: `${day} ${month}`, className: "older" };
                } else {
                    return { dateKey: date.toDateString(), label: `${day} ${month} ${year}`, className: "older" };
                }
            }
        }
        
        // Функция для создания разделителя даты
        function createDateDivider(dateInfo) {
            const divider = document.createElement('div');
            divider.className = `date-divider ${dateInfo.className}`;
            divider.innerHTML = `<div class="date-label">${dateInfo.label}</div>`;
            divider.setAttribute('data-date-key', dateInfo.dateKey);
            return divider;
        }
        
        // Функция для проверки и удаления пустых разделителей дат
        function checkAndRemoveEmptyDateDivider(removedMessageId) {
            if (!messagesMap.size) return;
            
            // Получаем дату удаленного сообщения
            const allMessages = Array.from(messagesMap.entries()).map(([id, data]) => ({
                id: id,
                ...data
            }));
            
            const dateGroups = new Map();
            allMessages.forEach(msg => {
                if (!msg.timestamp) return;
                const dateInfo = formatDateDivider(msg.timestamp);
                if (!dateGroups.has(dateInfo.dateKey)) {
                    dateGroups.set(dateInfo.dateKey, []);
                }
                dateGroups.get(dateInfo.dateKey).push(msg);
            });
            
            // Удаляем разделители для дат, в которых больше нет сообщений
            dateDividers.forEach((divider, dateKey) => {
                if (!dateGroups.has(dateKey)) {
                    if (divider.parentNode === messagesContainer) {
                        divider.classList.add('deleting');
                        setTimeout(() => {
                            divider.remove();
                        }, 300);
                    }
                    dateDividers.delete(dateKey);
                }
            });
        }
        
        // Инициализация эмодзи панели
        function initEmojiPicker() {
            emojiPicker.innerHTML = '';
            
            emojis.forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji-item';
                emojiElement.innerHTML = emoji.emoji;
                emojiElement.title = emoji.name;
                
                emojiElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    insertEmoji(emoji.emoji);
                    closeEmojiPicker();
                    messageInput.focus();
                });
                
                emojiPicker.appendChild(emojiElement);
            });
        }
        
        // Инициализация панели реакций
        function initReactionsPanel() {
            reactionsPanel.innerHTML = '';
            
            quickReactions.forEach(reaction => {
                const reactionElement = document.createElement('button');
                reactionElement.className = 'reaction-option';
                reactionElement.innerHTML = `
                    ${reaction.emoji}
                    <div class="reaction-tooltip">${reaction.name}</div>
                `;
                
                reactionElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentReactionPanelMessageId) {
                        addReaction(currentReactionPanelMessageId, reaction.emoji);
                        closeReactionsPanel();
                    }
                });
                
                reactionsPanel.appendChild(reactionElement);
            });
        }
        
        // Обновление стилей реакций на панели
        function updateReactionsPanel(messageId) {
            const reactionOptions = reactionsPanel.querySelectorAll('.reaction-option');
            
            if (!messageId) return;
            
            const userReactions = Array.from(reactionsMap.get(messageId) || [])
                .filter(reaction => reaction.userId === userId);
            
            reactionOptions.forEach(option => {
                const emoji = option.textContent.trim();
                const isMyReaction = userReactions.some(r => r.emoji === emoji);
                
                option.classList.toggle('my-reaction-option', isMyReaction);
            });
        }
        
        // Открытие панели реакций
        function openReactionsPanel(messageId, messageData, x, y) {
            currentReactionPanelMessageId = messageId;
            updateReactionsPanel(messageId);
            
            // Позиционирование панели
            const panelWidth = reactionsPanel.offsetWidth || 280;
            const panelHeight = reactionsPanel.offsetHeight || 120;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let posX = x - panelWidth / 2;
            let posY = y - panelHeight - 20;
            
            // Корректировка позиции, чтобы панель не выходила за границы экрана
            if (posX < 10) posX = 10;
            if (posX + panelWidth > viewportWidth - 10) posX = viewportWidth - panelWidth - 10;
            if (posY < 10) posY = y + 20;
            if (posY + panelHeight > viewportHeight - 10) posY = viewportHeight - panelHeight - 10;
            
            reactionsPanel.style.left = posX + 'px';
            reactionsPanel.style.top = posY + 'px';
            
            reactionsPanel.classList.add('active');
            reactionsOverlay.classList.add('active');
            isReactionsPanelOpen = true;
            
            // На мобильных устройствах центрируем панель
            if (window.innerWidth <= 768) {
                reactionsPanel.style.left = '50%';
                reactionsPanel.style.top = 'auto';
                reactionsPanel.style.bottom = '80px';
                reactionsPanel.style.transform = 'translateX(-50%)';
            }
            
            document.body.style.overflow = 'hidden';
        }
        
        // Закрытие панели реакций
        function closeReactionsPanel() {
            reactionsPanel.classList.remove('active');
            reactionsOverlay.classList.remove('active');
            isReactionsPanelOpen = false;
            currentReactionPanelMessageId = null;
            document.body.style.overflow = '';
        }
        
        // Вставить эмодзи в поле ввода
        function insertEmoji(emoji) {
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(cursorPos);
            
            messageInput.value = textBefore + emoji + textAfter;
            
            const newCursorPos = cursorPos + emoji.length;
            messageInput.selectionStart = messageInput.selectionEnd = newCursorPos;
            
            messageInput.focus();
            messageInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Открыть/закрыть панель эмодзи
        function toggleEmojiPicker(e) {
            if (e) e.stopPropagation();
            
            isEmojiPickerOpen = !isEmojiPickerOpen;
            emojiPicker.classList.toggle('active', isEmojiPickerOpen);
            emojiToggle.classList.toggle('active', isEmojiPickerOpen);
            
            if (isEmojiPickerOpen) {
                closeMenu();
                closeMessageMenu();
                closeReactionsPanel();
                setTimeout(() => {
                    document.addEventListener('click', closeEmojiPickerOnClickOutside);
                }, 10);
            } else {
                document.removeEventListener('click', closeEmojiPickerOnClickOutside);
            }
        }
        
        function closeEmojiPicker() {
            isEmojiPickerOpen = false;
            emojiPicker.classList.remove('active');
            emojiToggle.classList.remove('active');
            document.removeEventListener('click', closeEmojiPickerOnClickOutside);
        }
        
        function closeEmojiPickerOnClickOutside(e) {
            if (!emojiPicker.contains(e.target) && e.target !== emojiToggle) {
                closeEmojiPicker();
            }
        }
        
        // Функция добавления/удаления реакции
        function toggleReaction(messageId) {
            if (!userId || !userName) return;
            
            const userReactions = Array.from(reactionsMap.get(messageId) || [])
                .filter(reaction => reaction.userId === userId);
            
            if (userReactions.length > 0) {
                const reactionId = `${messageId}_${userId}`;
                reactionsRef.child(reactionId).remove();
            } else {
                const randomReaction = quickReactions[Math.floor(Math.random() * quickReactions.length)];
                addReaction(messageId, randomReaction.emoji);
            }
        }
        
        // Функция добавления реакции
        function addReaction(messageId, emoji) {
            if (!userId || !userName) return;
            
            const reactionId = `${messageId}_${userId}`;
            const reactionRef = reactionsRef.child(reactionId);
            
            reactionRef.set({
                messageId: messageId,
                emoji: emoji,
                userId: userId,
                userName: userName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        // Функция удаления реакции
        function removeReaction(messageId) {
            if (!userId) return;
            
            const reactionId = `${messageId}_${userId}`;
            reactionsRef.child(reactionId).remove();
        }
        
        // Обновление отображения реакций
        function updateMessageReactions(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const reactionsContainer = messageElement.querySelector('.reactions');
            if (!reactionsContainer) return;
            
            // Очищаем контейнер
            reactionsContainer.innerHTML = '';
            
            const messageReactions = reactionsMap.get(messageId) || [];
            
            // Если нет реакций - скрываем контейнер
            if (messageReactions.length === 0) {
                reactionsContainer.style.display = 'none';
                return;
            }
            
            // Есть реакции - показываем контейнер
            reactionsContainer.style.display = 'flex';
            
            const groupedReactions = {};
            
            messageReactions.forEach(reaction => {
                if (!groupedReactions[reaction.emoji]) {
                    groupedReactions[reaction.emoji] = {
                        count: 0,
                        users: []
                    };
                }
                groupedReactions[reaction.emoji].count++;
                groupedReactions[reaction.emoji].users.push(reaction.userId);
            });
            
            const sortedEmojis = Object.keys(groupedReactions).sort((a, b) => {
                return groupedReactions[b].count - groupedReactions[a].count;
            });
            
            sortedEmojis.forEach(emoji => {
                const reactionData = groupedReactions[emoji];
                const isMyReaction = reactionData.users.includes(userId);
                
                const reactionElement = document.createElement('div');
                reactionElement.className = `reaction ${isMyReaction ? 'my-reaction' : ''}`;
                reactionElement.innerHTML = `
                    <span class="reaction-emoji">${emoji}</span>
                    <span class="reaction-count">${reactionData.count}</span>
                `;
                
                reactionElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isMyReaction) {
                        removeReaction(messageId);
                    } else {
                        addReaction(messageId, emoji);
                    }
                });
                
                reactionsContainer.appendChild(reactionElement);
            });
        }
        
        // Функция для получения цвета аватарки по имени
        function getAvatarColor(name) {
            if (!name) return 0;
            const colors = 10;
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % colors;
        }
        
        // Функция для получения первой буквы имени
        function getFirstLetter(name) {
            if (!name || name.length === 0) return '?';
            return name.charAt(0).toUpperCase();
        }
        
        // Функция для обнаружения и преобразования URL в ссылки
        function linkify(text) {
            if (!text) return '';
            
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            
            return text.replace(urlRegex, function(url) {
                if (url.includes('<a ') && url.includes('</a>')) {
                    return url;
                }
                
                let href = url;
                if (!href.match(/^[a-zA-Z]+:\/\//)) {
                    href = 'http://' + href;
                }
                
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="message-link">${url}</a>`;
            });
        }
        
        // Функция для выделения найденного текста
        function highlightText(text, query) {
            if (!query || !text || query.length === 0) return text;
            
            try {
                const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedQuery})`, 'gi');
                
                return text.replace(regex, '<span class="search-match">$1</span>');
            } catch (e) {
                return text;
            }
        }
        
        // Функция для удаления HTML тегов
        function stripHtml(html) {
            if (!html) return '';
            return html.replace(/<[^>]*>/g, '');
        }
        
        // Функция проверки доступности имени
        async function checkNameAvailability(name) {
            return new Promise((resolve) => {
                onlineUsersRef.once('value', (snapshot) => {
                    let isAvailable = true;
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((child) => {
                            const user = child.val();
                            if (user.name.toLowerCase() === name.toLowerCase()) {
                                isAvailable = false;
                            }
                        });
                    }
                    
                    resolve(isAvailable);
                });
            });
        }
        
        // Функция для обновления статуса сообщения
        function updateMessageStatus(messageId, status) {
            if (!messageId || !userId) return;
            
            if (!messageStatusMap.has(messageId)) {
                messageStatusMap.set(messageId, {});
            }
            
            messageStatusMap.get(messageId)[userId] = status;
            
            const messageData = messagesMap.get(messageId);
            if (messageData && messageData.senderId === userId) {
                messageStatusRef.child(messageId).child(userId).set({
                    status: status,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Функция для получения HTML статуса сообщения
        function getMessageStatusHtml(status) {
            switch(status) {
                case 'delivered':
                    return `<span class="status-icon status-check delivered">✓</span>`;
                case 'read':
                    return `<span class="status-icon status-check read double-check">✓✓</span>`;
                default:
                    return `<span class="status-icon status-check">✓</span>`;
            }
        }
        
        // Функция для обновления отображения статуса сообщения
        function updateMessageStatusDisplay(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const timeElement = messageElement.querySelector('.time');
            if (!timeElement) return;
            
            const messageData = messagesMap.get(messageId);
            if (!messageData || messageData.senderId !== userId) return;
            
            const statuses = messageStatusMap.get(messageId) || {};
            let highestStatus = 'sent';
            
            Object.values(statuses).forEach(status => {
                if (status === 'read' && highestStatus !== 'read') {
                    highestStatus = 'read';
                } else if (status === 'delivered' && highestStatus === 'sent') {
                    highestStatus = 'delivered';
                }
            });
            
            const editedBadge = messageData.edited ? '<span class="edited-badge">(ред.)</span>' : '';
            const timeText = new Date(messageData.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            timeElement.innerHTML = `
                <span>${timeText}</span>
                <div class="message-status">
                    ${getMessageStatusHtml(highestStatus)}
                    ${editedBadge}
                </div>
            `;
        }
        
        // Функция закрепления сообщения
        function pinMessage(messageId, messageData) {
            if (!userId || !userName) return;
            
            const pinData = {
                messageId: messageId,
                sender: messageData.sender,
                senderId: messageData.senderId,
                text: stripHtml(messageData.text).substring(0, 100),
                timestamp: messageData.timestamp,
                pinnedBy: userName,
                pinnedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            pinnedMessageRef.set(pinData).then(() => {
                showNotification('Сообщение закреплено');
            });
        }
        
        // Функция открепления сообщения
        function unpinMessage() {
            pinnedMessageRef.remove().then(() => {
                showNotification('Сообщение откреплено');
            });
        }
        
        // Обновление панели закрепленного сообщения
        function updatePinnedPanel() {
            if (!currentPinnedMessage) {
                pinnedMessagePanel.classList.add('hidden');
                pinnedMessagePanel.classList.remove('active');
                mainContainer.classList.remove('with-pinned');
                return;
            }
            
            pinnedMessagePanel.classList.remove('hidden');
            pinnedMessagePanel.classList.add('active');
            mainContainer.classList.add('with-pinned');
            
            const avatarColor = getAvatarColor(currentPinnedMessage.sender);
            const firstLetter = getFirstLetter(currentPinnedMessage.sender);
            
            pinnedMessageAvatar.className = `pinned-message-avatar avatar-color-${avatarColor}`;
            pinnedMessageAvatar.textContent = firstLetter;
            
            pinnedMessageText.textContent = currentPinnedMessage.text + (currentPinnedMessage.text.length >= 100 ? '...' : '');
            
            // Обработчик клика для перехода к сообщению
            pinnedMessageContent.onclick = () => {
                const messageElement = document.querySelector(`[data-message-id="${currentPinnedMessage.messageId}"]`);
                if (messageElement) {
                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    messageElement.style.backgroundColor = 'rgba(102, 179, 255, 0.2)';
                    setTimeout(() => {
                        messageElement.style.backgroundColor = '';
                    }, 2000);
                }
            };
        }
        
        // Функция для показа уведомлений
        function showNotification(text) {
            // Создаем временное уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(51, 144, 236, 0.95);
                color: white;
                padding: 12px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 2000;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(10px);
                animation: fadeInOut 2s ease;
                pointer-events: none;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, 2000);
        }
        
        // Обновляем карту онлайн пользователей
        onlineUsersRef.on('value', (snapshot) => {
            onlineUsersMap.clear();
            
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const user = child.val();
                    onlineUsersMap.set(child.key, user);
                });
            }
        });
        
        // Обработчик изменения поля имени
        usernameInput.addEventListener('input', () => {
            const name = usernameInput.value.trim();
            
            if (nameCheckTimeout) {
                clearTimeout(nameCheckTimeout);
            }
            
            if (name.length < 2 || name.length > 20) {
                authButton.disabled = true;
                authButton.textContent = 'Войти в чат';
                errorMessage.style.display = 'block';
                checkingMessage.style.display = 'none';
                return;
            }
            
            authButton.disabled = true;
            authButton.textContent = 'Проверка...';
            errorMessage.style.display = 'none';
            checkingMessage.style.display = 'block';
            
            nameCheckTimeout = setTimeout(async () => {
                if (name !== usernameInput.value.trim()) {
                    return;
                }
                
                const isAvailable = await checkNameAvailability(name);
                
                if (name !== usernameInput.value.trim()) {
                    return;
                }
                
                checkingMessage.style.display = 'none';
                
                if (isAvailable) {
                    authButton.disabled = false;
                    authButton.textContent = 'Войти в чат';
                } else {
                    authButton.disabled = true;
                    authButton.textContent = 'Имя занято';
                    errorMessage.textContent = 'Это имя уже используется в чате';
                    errorMessage.style.display = 'block';
                }
                
                currentNameCheck = name;
            }, 500);
        });
        
        // Функция авторизации
        async function authorizeUser() {
            const name = usernameInput.value.trim();
            
            if (name.length < 2 || name.length > 20) {
                errorMessage.style.display = 'block';
                usernameInput.focus();
                return;
            }
            
            const isAvailable = await checkNameAvailability(name);
            
            if (!isAvailable) {
                authButton.disabled = true;
                authButton.textContent = 'Имя занято';
                errorMessage.textContent = 'Это имя уже используется в чате';
                errorMessage.style.display = 'block';
                usernameInput.focus();
                return;
            }
            
            errorMessage.style.display = 'none';
            checkingMessage.style.display = 'none';
            userName = name;
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            
            localStorage.setItem('chatUsername', userName);
            localStorage.setItem('chatUserId', userId);
            
            authModal.classList.add('hidden');
            mainHeader.classList.remove('hidden');
            mainContainer.classList.remove('hidden');
            
            currentUsername.textContent = userName;
            userAvatar.textContent = getFirstLetter(userName);
            userAvatar.className = `user-avatar avatar-color-${getAvatarColor(userName)}`;
            
            currentUserRef = onlineUsersRef.child(userId);
            
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true && currentUserRef) {
                    currentUserRef.set({
                        name: userName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    currentUserRef.onDisconnect().remove();
                }
            });
            
            initEmojiPicker();
            initReactionsPanel();
            
            setTimeout(() => {
                messageInput.focus();
            }, 100);
        }
        
        // Проверяем сохраненные данные
        async function checkSavedUser() {
            const savedName = localStorage.getItem('chatUsername');
            const savedId = localStorage.getItem('chatUserId');
            
            if (savedName && savedId) {
                const isAvailable = await checkNameAvailability(savedName);
                
                if (!isAvailable) {
                    localStorage.removeItem('chatUsername');
                    localStorage.removeItem('chatUserId');
                    
                    errorMessage.textContent = 'Ваше прежнее имя теперь занято. Выберите новое имя.';
                    errorMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        usernameInput.focus();
                    }, 100);
                    return;
                }
                
                userName = savedName;
                userId = savedId;
                
                authModal.classList.add('hidden');
                mainHeader.classList.remove('hidden');
                mainContainer.classList.remove('hidden');
                
                currentUsername.textContent = userName;
                userAvatar.textContent = getFirstLetter(userName);
                userAvatar.className = `user-avatar avatar-color-${getAvatarColor(userName)}`;
                
                currentUserRef = onlineUsersRef.child(userId);
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true && currentUserRef) {
                        currentUserRef.set({
                            name: userName,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        currentUserRef.onDisconnect().remove();
                    }
                });
                
                initEmojiPicker();
                initReactionsPanel();
                
                setTimeout(() => {
                    messageInput.focus();
                }, 100);
            }
        }
        
        // События авторизации
        authButton.addEventListener('click', authorizeUser);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !authButton.disabled) {
                authorizeUser();
            }
        });
        
        // Функция выхода
        function logout() {
            if (confirm('Выйти из чата?')) {
                if (currentUserRef) {
                    currentUserRef.remove();
                }
                
                localStorage.removeItem('chatUsername');
                localStorage.removeItem('chatUserId');
                
                location.reload();
            }
        }
        
        userAvatar.addEventListener('dblclick', logout);
        currentUsername.addEventListener('dblclick', logout);
        
        // Мобильное меню
        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            
            if (window.innerWidth <= 768) {
                // На мобильных устройствах
                isMenuOpen = !isMenuOpen;
                sidebar.classList.toggle('active', isMenuOpen);
                mobileOverlay.classList.toggle('active', isMenuOpen);
            } else {
                // На ПК - переключаем видимость сайдбара
                isSidebarVisible = !isSidebarVisible;
                sidebar.classList.toggle('hidden', !isSidebarVisible);
                
                // Обновляем иконку меню
                if (!isSidebarVisible) {
                    menuToggle.innerHTML = `
                        <div class="tg-icon">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                            </svg>
                        </div>
                    `;
                }
            }
            
            closeEmojiPicker();
            closeMessageMenu();
            closeReactionsPanel();
        });
        
        mobileOverlay.addEventListener('click', () => {
            isMenuOpen = false;
            sidebar.classList.remove('active');
            mobileOverlay.classList.remove('active');
            closeEmojiPicker();
            closeMessageMenu();
            closeReactionsPanel();
        });
        
        menuOverlay.addEventListener('click', closeMessageMenu);
        reactionsOverlay.addEventListener('click', closeReactionsPanel);
        unpinBtn.addEventListener('click', unpinMessage);
        
        function closeMenu() {
            isMenuOpen = false;
            sidebar.classList.remove('active');
            mobileOverlay.classList.remove('active');
        }
        
        // Эмодзи панель
        emojiToggle.addEventListener('click', toggleEmojiPicker);
        
        // Поиск сообщений
        function openSearchPanel() {
            mainHeader.classList.add('search-active');
            searchToggle.classList.add('active');
            isSearchActive = true;
            searchInput.focus();
            
            closeEmojiPicker();
            closeMessageMenu();
            closeReactionsPanel();
            closeMenu();
        }
        
        function closeSearchPanel() {
            mainHeader.classList.remove('search-active');
            searchToggle.classList.remove('active');
            searchResultsInfo.classList.remove('active');
            isSearchActive = false;
            clearSearchHighlights();
            searchInput.value = '';
            searchResults = [];
            currentSearchIndex = -1;
            searchQuery = '';
            
            loadMessages();
        }
        
        function clearSearchHighlights() {
            const highlightedMessages = document.querySelectorAll('.message-container.search-highlight, .message-container.search-current');
            highlightedMessages.forEach(msg => {
                msg.classList.remove('search-highlight', 'search-current');
            });
            
            const searchMatches = document.querySelectorAll('.search-match');
            searchMatches.forEach(match => {
                const parent = match.parentNode;
                parent.innerHTML = parent.innerHTML.replace(/<span class="search-match">(.*?)<\/span>/g, '$1');
            });
        }
        
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (!query || query.length < 1) {
                searchResultsInfo.classList.add('active');
                searchResultsText.textContent = 'Введите хотя бы 1 символ для поиска';
                setTimeout(() => {
                    searchResultsInfo.classList.remove('active');
                }, 2000);
                return;
            }
            
            searchQuery = query;
            searchResults = [];
            currentSearchIndex = -1;
            
            messagesMap.forEach((messageData, messageId) => {
                const text = stripHtml(messageData.text).toLowerCase();
                const sender = messageData.sender.toLowerCase();
                
                if (text.includes(query) || sender.includes(query)) {
                    searchResults.push({
                        id: messageId,
                        data: messageData,
                        textIndex: text.indexOf(query),
                        senderIndex: sender.indexOf(query)
                    });
                }
            });
            
            searchResults.sort((a, b) => (b.data.timestamp || 0) - (a.data.timestamp || 0));
            
            if (searchResults.length === 0) {
                searchResultsInfo.classList.add('active');
                searchResultsText.textContent = 'Сообщения не найдены';
                setTimeout(() => {
                    searchResultsInfo.classList.remove('active');
                }, 3000);
                return;
            }
            
            showSearchResults();
            navigateToSearchResult(0);
            
            searchResultsInfo.classList.add('active');
            searchResultsText.textContent = `Найдено ${searchResults.length} сообщений`;
            setTimeout(() => {
                if (currentSearchIndex === -1) {
                    searchResultsInfo.classList.remove('active');
                }
            }, 2000);
        }
        
        function showSearchResults() {
            clearSearchHighlights();
            
            searchResults.forEach(result => {
                const messageElement = document.querySelector(`[data-message-id="${result.id}"]`);
                if (messageElement) {
                    messageElement.classList.add('search-highlight');
                    
                    const textElement = messageElement.querySelector('.text');
                    if (textElement) {
                        const originalText = stripHtml(textElement.innerHTML);
                        const highlightedText = highlightText(originalText, searchQuery);
                        textElement.innerHTML = linkify(highlightedText).replace(
                            /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                            match => `<span class="emoji">${match}</span>`
                        );
                    }
                }
            });
        }
        
        function navigateToSearchResult(index) {
            if (searchResults.length === 0) return;
            
            if (index < 0) index = 0;
            if (index >= searchResults.length) index = searchResults.length - 1;
            
            if (currentSearchIndex >= 0 && currentSearchIndex < searchResults.length) {
                const prevElement = document.querySelector(`[data-message-id="${searchResults[currentSearchIndex].id}"]`);
                if (prevElement) {
                    prevElement.classList.remove('search-current');
                    prevElement.classList.add('search-highlight');
                }
            }
            
            currentSearchIndex = index;
            
            const currentResult = searchResults[currentSearchIndex];
            const currentElement = document.querySelector(`[data-message-id="${currentResult.id}"]`);
            if (currentElement) {
                currentElement.classList.remove('search-highlight');
                currentElement.classList.add('search-current');
                
                currentElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                searchResultsInfo.classList.add('active');
                searchResultsText.textContent = `${currentSearchIndex + 1} из ${searchResults.length}`;
                
                searchPrev.disabled = currentSearchIndex === 0;
                searchNext.disabled = currentSearchIndex === searchResults.length - 1;
            }
        }
        
        // Обработчики для поиска
        searchToggle.addEventListener('click', openSearchPanel);
        closeSearch.addEventListener('click', closeSearchPanel);
        searchPrev.addEventListener('click', () => navigateToSearchResult(currentSearchIndex - 1));
        searchNext.addEventListener('click', () => navigateToSearchResult(currentSearchIndex + 1));
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isSearchActive) {
                closeSearchPanel();
            } else if (e.key === 'Escape' && isReactionsPanelOpen) {
                closeReactionsPanel();
            } else if (e.key === 'Escape' && messageMenu.classList.contains('active')) {
                closeMessageMenu();
            }
        });
        
        // Контекстное меню для сообщений
        function showMessageMenu(messageId, messageData, x, y) {
            closeMessageMenu();
            
            currentContextMessage = {
                id: messageId,
                data: messageData
            };
            
            messageMenu.style.left = x + 'px';
            messageMenu.style.top = y + 'px';
            
            const isMyMessage = messageData.senderId === userId;
            const isPinned = currentPinnedMessage && currentPinnedMessage.messageId === messageId;
            
            menuReplyBtn.style.display = 'flex';
            menuReactBtn.style.display = 'flex';
            menuPinBtn.style.display = !isPinned ? 'flex' : 'none';
            menuUnpinBtn.style.display = isPinned ? 'flex' : 'none';
            menuEditBtn.style.display = isMyMessage ? 'flex' : 'none';
            menuDeleteBtn.style.display = isMyMessage ? 'flex' : 'none';
            
            messageMenu.classList.add('active');
            menuOverlay.classList.add('active');
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeMessageMenu() {
            messageMenu.classList.remove('active');
            menuOverlay.classList.remove('active');
            currentContextMessage = null;
            
            document.body.style.overflow = '';
        }
        
        // Обработчики для меню
        menuReplyBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                replyToMessage(currentContextMessage.id, currentContextMessage.data);
                closeMessageMenu();
            }
        });
        
        menuReactBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                const rect = messageMenu.getBoundingClientRect();
                openReactionsPanel(currentContextMessage.id, currentContextMessage.data, rect.left, rect.top);
                closeMessageMenu();
            }
        });
        
        menuPinBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                pinMessage(currentContextMessage.id, currentContextMessage.data);
                closeMessageMenu();
            }
        });
        
        menuUnpinBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                unpinMessage();
                closeMessageMenu();
            }
        });
        
        menuEditBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                editMessage(currentContextMessage.id, currentContextMessage.data.text);
                closeMessageMenu();
            }
        });
        
        menuDeleteBtn.addEventListener('click', () => {
            if (currentContextMessage) {
                deleteMessage(currentContextMessage.id);
                closeMessageMenu();
            }
        });
        
        // Функция ответа на сообщение
        function replyToMessage(messageId, messageData) {
            replyingToMessage = {
                id: messageId,
                sender: messageData.sender,
                text: stripHtml(messageData.text).substring(0, 100)
            };
            
            replyIndicator.classList.remove('hidden');
            replyIndicatorText.textContent = `Ответ ${messageData.sender}: ${replyingToMessage.text}${replyingToMessage.text.length >= 100 ? '...' : ''}`;
            
            messageInput.focus();
            
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    messageInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }
        
        // Отмена ответа
        cancelReplyBtn.addEventListener('click', () => {
            cancelReply();
        });
        
        function cancelReply() {
            replyingToMessage = null;
            replyIndicator.classList.add('hidden');
            messageInput.focus();
        }
        
        // Функция удаления сообщения
        function deleteMessage(messageId) {
            if (confirm('Удалить это сообщение?')) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.classList.add('deleting');
                    
                    messagesRef.child(messageId).remove().then(() => {
                        messagesMap.delete(messageId);
                        
                        setTimeout(() => {
                            if (messageElement.parentNode) {
                                messageElement.remove();
                                checkAndRemoveEmptyDateDivider(messageId);
                            }
                        }, 300);
                    });
                } else {
                    messagesRef.child(messageId).remove();
                }
            }
        }
        
        // Функция редактирования сообщения
        function editMessage(messageId, currentText) {
            if (editingMessageId && editingMessageId !== messageId) {
                cancelEdit();
            }
            
            editingMessageId = messageId;
            
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const textElement = messageElement.querySelector('.text');
            const messageDiv = messageElement.querySelector('.message');
            const timeElement = messageElement.querySelector('.time');
            
            if (textElement && messageDiv) {
                const originalText = textElement.innerHTML;
                const originalTime = timeElement ? timeElement.innerHTML : '';
                
                messageDiv.classList.add('editing');
                
                const editInput = document.createElement('textarea');
                editInput.className = 'edit-input';
                editInput.value = stripHtml(currentText);
                editInput.rows = 1;
                editInput.style.resize = 'none';
                editInput.style.overflow = 'hidden';
                
                const parent = textElement.parentNode;
                parent.replaceChild(editInput, textElement);
                
                editInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                
                setTimeout(() => {
                    editInput.style.height = 'auto';
                    editInput.style.height = (editInput.scrollHeight) + 'px';
                    editInput.focus();
                    editInput.setSelectionRange(editInput.value.length, editInput.value.length);
                }, 10);
                
                const editControls = document.createElement('div');
                editControls.className = 'edit-controls';
                editControls.innerHTML = `
                    <button class="edit-btn save-btn">Сохранить</button>
                    <button class="edit-btn cancel-btn">Отмена</button>
                `;
                
                if (timeElement) {
                    parent.insertBefore(editControls, timeElement);
                } else {
                    parent.appendChild(editControls);
                }
                
                const saveBtn = editControls.querySelector('.save-btn');
                const cancelBtn = editControls.querySelector('.cancel-btn');
                
                saveBtn.addEventListener('click', () => {
                    saveEditedMessage(messageId, editInput.value.trim());
                });
                
                cancelBtn.addEventListener('click', () => {
                    cancelEditMessage(messageElement, originalText, originalTime);
                });
                
                editInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveEditedMessage(messageId, editInput.value.trim());
                    } else if (e.key === 'Escape') {
                        cancelEditMessage(messageElement, originalText, originalTime);
                    }
                });
            }
        }
        
        // Функция сохранения отредактированного сообщения
        function saveEditedMessage(messageId, newText) {
            if (!newText || newText.trim() === '') {
                alert('Сообщение не может быть пустым');
                return;
            }
            
            const updateData = {
                text: newText,
                edited: true,
                editTimestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            if (messagesMap.has(messageId)) {
                const messageData = messagesMap.get(messageId);
                messageData.text = newText;
                messageData.edited = true;
                messageData.editTimestamp = Date.now();
                
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    const editInput = messageElement.querySelector('.edit-input');
                    const editControls = messageElement.querySelector('.edit-controls');
                    const messageDiv = messageElement.querySelector('.message');
                    
                    if (editInput) {
                        const textDiv = document.createElement('div');
                        textDiv.className = 'text';
                        let processedText = linkify(newText);
                        processedText = processedText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                            match => `<span class="emoji">${match}</span>`);
                        textDiv.innerHTML = processedText;
                        
                        editInput.parentNode.replaceChild(textDiv, editInput);
                    }
                    
                    if (editControls) {
                        editControls.remove();
                    }
                    
                    if (messageDiv) {
                        messageDiv.classList.remove('editing');
                    }
                    
                    updateMessageStatusDisplay(messageId);
                }
            }
            
            messagesRef.child(messageId).update(updateData).then(() => {
                editingMessageId = null;
                messageInput.focus();
            });
        }
        
        // Функция отмены редактирования конкретного сообщения
        function cancelEditMessage(messageElement, originalText, originalTime) {
            const editInput = messageElement.querySelector('.edit-input');
            const editControls = messageElement.querySelector('.edit-controls');
            const messageDiv = messageElement.querySelector('.message');
            
            if (editInput && editControls) {
                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.innerHTML = originalText;
                
                editInput.parentNode.replaceChild(textDiv, editInput);
                editControls.remove();
                
                messageDiv.classList.remove('editing');
                
                const timeElement = messageElement.querySelector('.time');
                if (timeElement && originalTime) {
                    timeElement.innerHTML = originalTime;
                }
            }
            
            editingMessageId = null;
            messageInput.focus();
        }
        
        // Функция отмены редактирования
        function cancelEdit() {
            if (editingMessageId) {
                const messageElement = document.querySelector(`[data-message-id="${editingMessageId}"]`);
                if (messageElement) {
                    const originalData = messagesMap.get(editingMessageId);
                    if (originalData) {
                        const textElement = messageElement.querySelector('.text');
                        const timeElement = messageElement.querySelector('.time');
                        
                        if (textElement) {
                            let processedText = linkify(originalData.text);
                            processedText = processedText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                                match => `<span class="emoji">${match}</span>`);
                            textElement.innerHTML = processedText;
                        }
                        
                        const messageDiv = messageElement.querySelector('.message');
                        const editInput = messageElement.querySelector('.edit-input');
                        const editControls = messageElement.querySelector('.edit-controls');
                        
                        if (messageDiv) messageDiv.classList.remove('editing');
                        if (editInput) editInput.remove();
                        if (editControls) editControls.remove();
                        
                        updateMessageStatusDisplay(editingMessageId);
                    }
                }
                
                editingMessageId = null;
            }
        }
        
        // Функция создания элемента сообщения
        function createMessageElement(messageData, messageId) {
            const isMyMessage = messageData.senderId === userId;
            const container = document.createElement('div');
            container.className = `message-container ${isMyMessage ? 'my' : 'other'}`;
            container.setAttribute('data-message-id', messageId);
            
            const avatarColor = getAvatarColor(messageData.sender);
            const firstLetter = getFirstLetter(messageData.sender);
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar avatar-color-${avatarColor}`;
            avatar.textContent = firstLetter;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message`;
            
            // Добавляем класс pinned если сообщение закреплено
            if (currentPinnedMessage && currentPinnedMessage.messageId === messageId) {
                messageDiv.classList.add('pinned');
            }
            
            let replyBlock = '';
            if (messageData.replyTo) {
                const replyMessage = messagesMap.get(messageData.replyTo.messageId);
                if (replyMessage) {
                    const replyText = stripHtml(replyMessage.text).substring(0, 80);
                    replyBlock = `
                        <div class="reply-block">
                            <div class="reply-sender">
                                <span>
                                    <span class="reply-icon">
                                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/>
                                        </svg>
                                    </span>
                                    ${replyMessage.sender}
                                </span>
                                <button class="close-reply" data-reply-id="${messageData.replyTo.messageId}">×</button>
                            </div>
                            <div class="reply-text">${replyText}${replyText.length >= 80 ? '...' : ''}</div>
                        </div>
                    `;
                }
            }
            
            let processedText = linkify(messageData.text);
            
            if (isSearchActive && searchQuery) {
                processedText = highlightText(stripHtml(processedText), searchQuery);
            }
            
            processedText = processedText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                match => `<span class="emoji">${match}</span>`);
            
            const timeText = new Date(messageData.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            const editedBadge = messageData.edited ? '<span class="edited-badge">(ред.)</span>' : '';
            
            let statusHtml = '';
            if (isMyMessage) {
                const statuses = messageStatusMap.get(messageId) || {};
                let highestStatus = 'sent';
                
                Object.values(statuses).forEach(status => {
                    if (status === 'read' && highestStatus !== 'read') {
                        highestStatus = 'read';
                    } else if (status === 'delivered' && highestStatus === 'sent') {
                        highestStatus = 'delivered';
                    }
                });
                
                statusHtml = getMessageStatusHtml(highestStatus);
            }
            
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'reactions';
            reactionsDiv.style.display = 'none'; // Скрываем по умолчанию
            
            messageDiv.innerHTML = `
                <div class="sender">${messageData.sender}</div>
                ${replyBlock}
                <div class="text">${processedText}</div>
                <div class="time">
                    <span>${timeText}</span>
                    <div class="message-status">
                        ${statusHtml}
                        ${editedBadge}
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(reactionsDiv);
            
            if (isMyMessage) {
                container.appendChild(messageDiv);
                container.appendChild(avatar);
            } else {
                container.appendChild(avatar);
                container.appendChild(messageDiv);
            }
            

            messageDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                closeEmojiPicker();
                closeMenu();
                closeReactionsPanel();
                
                const rect = messageDiv.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                showMessageMenu(messageId, messageData, x, y);
            });
            
            const closeReplyBtn = messageDiv.querySelector('.close-reply');
            if (closeReplyBtn) {
                closeReplyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const replyId = closeReplyBtn.getAttribute('data-reply-id');
                    const replyMessageElement = document.querySelector(`[data-message-id="${replyId}"]`);
                    if (replyMessageElement) {
                        replyMessageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        replyMessageElement.style.backgroundColor = 'rgba(102, 179, 255, 0.2)';
                        setTimeout(() => {
                            replyMessageElement.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            }
            
            return container;
        }
        
        // Функция загрузки сообщений с разделителями дат
        function loadMessages() {
            if (!messagesMap.size) return;
            
            const messages = Array.from(messagesMap.entries()).map(([id, data]) => ({
                id: id,
                ...data
            }));
            
            messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            // Группируем сообщения по датам
            messagesByDate.clear();
            messages.forEach(msg => {
                if (!msg.timestamp) return;
                
                const dateInfo = formatDateDivider(msg.timestamp);
                if (!messagesByDate.has(dateInfo.dateKey)) {
                    messagesByDate.set(dateInfo.dateKey, {
                        info: dateInfo,
                        messages: []
                    });
                }
                messagesByDate.get(dateInfo.dateKey).messages.push(msg);
            });
            
            // Создаем контейнер для сообщений
            if (editingMessageId) {
                // Если есть редактируемое сообщение, сохраняем его
                const editingMessage = messages.find(m => m.id === editingMessageId);
                if (editingMessage) {
                    const messageElement = document.querySelector(`[data-message-id="${editingMessageId}"]`);
                    if (messageElement && !messageElement.querySelector('.edit-input')) {
                        const textElement = messageElement.querySelector('.text');
                        const timeElement = messageElement.querySelector('.time');
                        
                        if (textElement) {
                            let processedText = linkify(editingMessage.text);
                            processedText = processedText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                                match => `<span class="emoji">${match}</span>`);
                            textElement.innerHTML = processedText;
                        }
                        
                        if (timeElement) {
                            updateMessageStatusDisplay(editingMessageId);
                        }
                    }
                }
                
                // Очищаем контейнер и перерисовываем все
                messagesContainer.innerHTML = '';
                
                messagesByDate.forEach((dateData, dateKey) => {
                    // Добавляем разделитель даты
                    const divider = createDateDivider(dateData.info);
                    messagesContainer.appendChild(divider);
                    dateDividers.set(dateKey, divider);
                    
                    // Добавляем сообщения для этой даты
                    dateData.messages.forEach(msg => {
                        if (msg.id === editingMessageId) {
                            const existingElement = document.querySelector(`[data-message-id="${editingMessageId}"]`);
                            if (existingElement) {
                                messagesContainer.appendChild(existingElement);
                            } else {
                                messagesContainer.appendChild(createMessageElement(msg, msg.id));
                            }
                        } else {
                            messagesContainer.appendChild(createMessageElement(msg, msg.id));
                        }
                    });
                });
            } else {
                // Полная перерисовка
                messagesContainer.innerHTML = '';
                dateDividers.clear();
                
                messagesByDate.forEach((dateData, dateKey) => {
                    // Добавляем разделитель даты
                    const divider = createDateDivider(dateData.info);
                    messagesContainer.appendChild(divider);
                    dateDividers.set(dateKey, divider);
                    
                    // Добавляем сообщения для этой даты
                    dateData.messages.forEach(msg => {
                        messagesContainer.appendChild(createMessageElement(msg, msg.id));
                    });
                });
            }
            
            // Обновляем реакции и статусы
            messages.forEach(msg => {
                updateMessageReactions(msg.id);
                updateMessageStatusDisplay(msg.id);
            });
            
            // Прокручиваем вниз
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Загрузка и обновление сообщений
        messagesRef.orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
            if (!snapshot.exists()) {
                messagesContainer.innerHTML = `
                    <div class="date-divider today">
                        <div class="date-label">Сегодня</div>
                    </div>
                    <div class="message-container other">
                        <div class="message-avatar other avatar-color-0">С</div>
                        <div class="message other">
                            <div class="text">Нет сообщений</div>
                        </div>
                    </div>
                `;
                messagesMap.clear();
                messagesByDate.clear();
                dateDividers.clear();
                return;
            }
            
            messagesMap.clear();
            messagesByDate.clear();
            snapshot.forEach((child) => {
                messagesMap.set(child.key, child.val());
            });
            
            loadMessages();
        });
        
        // Обработчик для добавления новых сообщений
        messagesRef.orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
            const newMessage = snapshot.val();
            const newMessageId = snapshot.key;
            
            if (!newMessage || !newMessage.timestamp) return;
            
            const dateInfo = formatDateDivider(newMessage.timestamp);
            const dateKey = dateInfo.dateKey;
            
            // Если для этой даты еще нет разделителя
            if (!dateDividers.has(dateKey)) {
                // Находим куда вставить разделитель (перед сообщением)
                const allMessages = Array.from(messagesMap.entries())
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                // Определяем индекс для вставки
                const insertIndex = allMessages.findIndex(msg => {
                    const msgDate = formatDateDivider(msg.timestamp);
                    return msgDate.dateKey === dateKey;
                });
                
                if (insertIndex !== -1) {
                    // Вставляем разделитель
                    setTimeout(() => {
                        const firstMessageOfDate = document.querySelector(`[data-message-id="${allMessages[insertIndex].id}"]`);
                        if (firstMessageOfDate && firstMessageOfDate.parentNode === messagesContainer) {
                            const divider = createDateDivider(dateInfo);
                            messagesContainer.insertBefore(divider, firstMessageOfDate);
                            dateDividers.set(dateKey, divider);
                        }
                    }, 50);
                }
            }
            
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        });

        // Обработчик для изменений в сообщениях
        messagesRef.on('child_changed', (snapshot) => {
            const messageId = snapshot.key;
            const messageData = snapshot.val();
            
            messagesMap.set(messageId, messageData);
            
            if (messageId !== editingMessageId) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    const textElement = messageElement.querySelector('.text');
                    const timeElement = messageElement.querySelector('.time');
                    
                    if (textElement) {
                        let processedText = linkify(messageData.text);
                        processedText = processedText.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, 
                            match => `<span class="emoji">${match}</span>`);
                        textElement.innerHTML = processedText;
                    }
                    
                    if (timeElement) {
                        updateMessageStatusDisplay(messageId);
                    }
                }
            }
        });
        
        // Обработчик для удаления сообщений
        messagesRef.on('child_removed', (snapshot) => {
            const messageId = snapshot.key;
            
            messagesMap.delete(messageId);
            messageStatusMap.delete(messageId);
            
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('deleting');
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                        checkAndRemoveEmptyDateDivider(messageId);
                    }
                }, 300);
            }
        });
        
        // Загрузка и обновление статусов сообщений
        messageStatusRef.on('value', (snapshot) => {
            messageStatusMap.clear();
            
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const messageId = child.key;
                    
                    child.forEach((userStatus) => {
                        const userId = userStatus.key;
                        const statusData = userStatus.val();
                        
                        if (!messageStatusMap.has(messageId)) {
                            messageStatusMap.set(messageId, {});
                        }
                        
                        messageStatusMap.get(messageId)[userId] = statusData.status;
                    });
                });
                
                messageStatusMap.forEach((statuses, messageId) => {
                    updateMessageStatusDisplay(messageId);
                });
            }
        });
        
        // Загрузка и обновление реакций
        reactionsRef.on('value', (snapshot) => {
            reactionsMap.clear();
            
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const reaction = child.val();
                    const messageId = reaction.messageId;
                    
                    if (!reactionsMap.has(messageId)) {
                        reactionsMap.set(messageId, []);
                    }
                    
                    reactionsMap.get(messageId).push(reaction);
                });
                
                reactionsMap.forEach((reactions, messageId) => {
                    updateMessageReactions(messageId);
                });
                
                messagesMap.forEach((messageData, messageId) => {
                    if (!reactionsMap.has(messageId)) {
                        updateMessageReactions(messageId);
                    }
                });
            } else {
                messagesMap.forEach((messageData, messageId) => {
                    updateMessageReactions(messageId);
                });
            }
        });
        
        // Обработчик для добавления/удаления реакций
        reactionsRef.on('child_added', (snapshot) => {
            const reaction = snapshot.val();
            const messageId = reaction.messageId;
            
            if (!reactionsMap.has(messageId)) {
                reactionsMap.set(messageId, []);
            }
            
            reactionsMap.get(messageId).push(reaction);
            updateMessageReactions(messageId);
            
            // Обновляем панель реакций если она открыта
            if (currentReactionPanelMessageId === messageId) {
                updateReactionsPanel(messageId);
            }
        });
        
        reactionsRef.on('child_changed', (snapshot) => {
            const updatedReaction = snapshot.val();
            const messageId = updatedReaction.messageId;
            
            if (reactionsMap.has(messageId)) {
                const index = reactionsMap.get(messageId).findIndex(r => 
                    r.userId === updatedReaction.userId && r.messageId === updatedReaction.messageId
                );
                
                if (index !== -1) {
                    reactionsMap.get(messageId)[index] = updatedReaction;
                }
                
                updateMessageReactions(messageId);
                
                // Обновляем панель реакций если она открыта
                if (currentReactionPanelMessageId === messageId) {
                    updateReactionsPanel(messageId);
                }
            }
        });
        
        reactionsRef.on('child_removed', (snapshot) => {
            const removedReaction = snapshot.val();
            const messageId = removedReaction.messageId;
            
            if (reactionsMap.has(messageId)) {
                reactionsMap.set(messageId, 
                    reactionsMap.get(messageId).filter(r => 
                        !(r.userId === removedReaction.userId && r.messageId === removedReaction.messageId)
                    )
                );
                
                updateMessageReactions(messageId);
                
                // Обновляем панель реакций если она открыта
                if (currentReactionPanelMessageId === messageId) {
                    updateReactionsPanel(messageId);
                }
            }
        });
        
        // Загрузка и обновление закрепленного сообщения (одного)
        pinnedMessageRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                currentPinnedMessage = snapshot.val();
                updatePinnedPanel();
            } else {
                currentPinnedMessage = null;
                updatePinnedPanel();
            }
            
            // Обновляем отображение закрепленного сообщения в чате
            messagesMap.forEach((messageData, messageId) => {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    const messageDiv = messageElement.querySelector('.message');
                    if (messageDiv) {
                        if (currentPinnedMessage && currentPinnedMessage.messageId === messageId) {
                            messageDiv.classList.add('pinned');
                        } else {
                            messageDiv.classList.remove('pinned');
                        }
                    }
                }
            });
        });
        
        // Функция отправки сообщения
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !userId) return;
            
            const messageId = messagesRef.push().key;
            const messageData = {
                text: text,
                sender: userName,
                senderId: userId,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                edited: false
            };
            
            if (replyingToMessage) {
                messageData.replyTo = {
                    messageId: replyingToMessage.id,
                    sender: replyingToMessage.sender,
                    text: replyingToMessage.text
                };
            }
            
            messagesRef.child(messageId).set(messageData).then(() => {
                messageInput.value = '';
                cancelReply();
                messageInput.focus();
                closeEmojiPicker();
                
                updateMessageStatus(messageId, 'sent');
                
                setTimeout(() => {
                    updateMessageStatus(messageId, 'delivered');
                    
                    setTimeout(() => {
                        if (onlineUsersMap.has(userId)) {
                            updateMessageStatus(messageId, 'read');
                        }
                    }, 2000);
                }, 1000);
            });
        }
        
        // Обработчики событий
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Обработка кликов по ссылкам
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href) {
                if (link.classList.contains('message-link')) {
                    e.preventDefault();
                    window.open(link.href, '_blank', 'noopener,noreferrer');
                }
            }
        });
        
        // Закрытие всех меню при клике вне их
        document.addEventListener('click', (e) => {
            if (isEmojiPickerOpen && !emojiPicker.contains(e.target) && e.target !== emojiToggle) {
                closeEmojiPicker();
            }
            if (isMenuOpen && !sidebar.contains(e.target) && e.target !== menuToggle) {
                closeMenu();
            }
        });
        
        // Очистка при закрытии страницы
        window.addEventListener('beforeunload', () => {
            if (currentUserRef) {
                currentUserRef.remove();
            }
        });
        
        // Проверяем сохраненного пользователя при загрузке
        window.addEventListener('load', () => {
            checkSavedUser();
            if (!userName) {
                usernameInput.focus();
            }
        });
        
        // Отслеживание онлайн пользователей
        onlineUsersRef.on('value', (snapshot) => {
            userList.innerHTML = '';
            
            if (!snapshot.exists()) {
                onlineCount.textContent = '0';
                return;
            }
            
            const users = [];
            snapshot.forEach((child) => {
                users.push({
                    id: child.key,
                    ...child.val()
                });
            });
            
            onlineCount.textContent = users.length;
            
            users.sort((a, b) => {
                if (a.id === userId) return -1;
                if (b.id === userId) return 1;
                return a.name.localeCompare(b.name);
            });
            
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = `user-item ${user.id === userId ? 'you' : ''}`;
                
                const avatarColor = getAvatarColor(user.name);
                const firstLetter = getFirstLetter(user.name);
                
                li.innerHTML = `
                    <div class="user-avatar-small avatar-color-${avatarColor}">${firstLetter}</div>
                    <div class="user-name">${user.name}${user.id === userId ? ' (Вы)' : ''}</div>
                `;
                userList.appendChild(li);
            });
        });
    </script>
</body>
</html>
