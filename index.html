<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Мессенджер</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        #container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1, h2 { 
            text-align: center; 
            color: #333;
        }
        #connectSection, #chatSection {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #chatSection {
            display: none;
        }
        textarea, input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            max-width: 80%;
        }
        .local {
            background: #d4edda;
            margin-left: auto;
            text-align: right;
        }
        .remote {
            background: #e2e3e5;
            margin-right: auto;
        }
        #status {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .waiting { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div id="container">
        <h1>P2P Мессенджер</h1>
        
        <div id="connectSection">
            <h2>Подключение</h2>
            <div id="status" class="disconnected">Отключен</div>
            
            <button id="createOffer">Создать предложение (Пользователь 1)</button>
            
            <h3>или</h3>
            
            <label>Введите предложение от другого пользователя:</label>
            <textarea id="remoteOffer" placeholder="Вставьте предложение сюда..." rows="4"></textarea>
            <button id="createAnswer">Принять предложение (Пользователь 2)</button>
            
            <h3>или</h3>
            
            <label>Введите ответ от другого пользователя:</label>
            <textarea id="remoteAnswer" placeholder="Вставьте ответ сюда..." rows="4"></textarea>
            <button id="acceptAnswer">Принять ответ</button>
        </div>
        
        <div id="chatSection">
            <h2>Чат</h2>
            <div id="messages"></div>
            
            <textarea id="messageInput" placeholder="Введите сообщение..." rows="2"></textarea>
            <button id="sendButton">Отправить</button>
            <button id="disconnectButton">Отключиться</button>
        </div>
    </div>

    <script>
        let peerConnection;
        let dataChannel;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectSection = document.getElementById('connectSection');
        const chatSection = document.getElementById('chatSection');

        // Обновление статуса
        function updateStatus(text, className) {
            statusDiv.textContent = text;
            statusDiv.className = className;
        }

        // Создание предложения (Пользователь 1)
        document.getElementById('createOffer').onclick = async () => {
            try {
                updateStatus('Создание соединения...', 'waiting');
                
                peerConnection = new RTCPeerConnection(configuration);
                setupDataChannel();
                
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannelListeners(dataChannel);
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                document.getElementById('remoteOffer').value = JSON.stringify(offer);
                updateStatus('Предложение создано. Отправьте его другому пользователю', 'waiting');
            } catch (error) {
                console.error('Ошибка создания предложения:', error);
                updateStatus('Ошибка создания предложения', 'disconnected');
            }
        };

        // Принятие предложения (Пользователь 2)
        document.getElementById('createAnswer').onclick = async () => {
            try {
                const offer = JSON.parse(document.getElementById('remoteOffer').value);
                updateStatus('Принятие предложения...', 'waiting');
                
                peerConnection = new RTCPeerConnection(configuration);
                setupDataChannel();
                
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannelListeners(dataChannel);
                };
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                document.getElementById('remoteAnswer').value = JSON.stringify(answer);
                updateStatus('Ответ создан. Отправьте его обратно', 'waiting');
            } catch (error) {
                console.error('Ошибка принятия предложения:', error);
                updateStatus('Ошибка принятия предложения', 'disconnected');
            }
        };

        // Принятие ответа (Пользователь 1)
        document.getElementById('acceptAnswer').onclick = async () => {
            try {
                const answer = JSON.parse(document.getElementById('remoteAnswer').value);
                updateStatus('Принятие ответа...', 'waiting');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                updateStatus('Соединение установлено!', 'connected');
                showChat();
            } catch (error) {
                console.error('Ошибка принятия ответа:', error);
                updateStatus('Ошибка принятия ответа', 'disconnected');
            }
        };

        // Настройка обработчиков ICE кандидатов
        function setupDataChannel() {
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Новый ICE кандидат:', event.candidate);
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('Состояние соединения:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    updateStatus('Соединение установлено!', 'connected');
                    showChat();
                } else if (peerConnection.connectionState === 'disconnected' || 
                           peerConnection.connectionState === 'failed' || 
                           peerConnection.connectionState === 'closed') {
                    updateStatus('Соединение разорвано', 'disconnected');
                    hideChat();
                }
            };
        }

        // Настройка обработчиков канала данных
        function setupDataChannelListeners(channel) {
            channel.onopen = () => {
                console.log('Канал данных открыт');
                updateStatus('Соединение установлено!', 'connected');
                showChat();
            };
            
            channel.onclose = () => {
                console.log('Канал данных закрыт');
                updateStatus('Соединение разорвано', 'disconnected');
                hideChat();
            };
            
            channel.onerror = (error) => {
                console.error('Ошибка канала данных:', error);
                updateStatus('Ошибка соединения', 'disconnected');
                hideChat();
            };
            
            channel.onmessage = (event) => {
                addMessage(event.data, 'remote');
            };
        }

        // Отправка сообщения
        sendButton.onclick = () => {
            const message = messageInput.value.trim();
            if (message && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                addMessage(message, 'local');
                messageInput.value = '';
            }
        };

        // Отправка по Enter
        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        };

        // Отключение
        document.getElementById('disconnectButton').onclick = () => {
            if (dataChannel) {
                dataChannel.close();
            }
            if (peerConnection) {
                peerConnection.close();
            }
            updateStatus('Отключен', 'disconnected');
            hideChat();
        };

        // Добавление сообщения в чат
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Показать интерфейс чата
        function showChat() {
            connectSection.style.display = 'none';
            chatSection.style.display = 'block';
            messageInput.focus();
        }

        // Скрыть интерфейс чата
        function hideChat() {
            connectSection.style.display = 'block';
            chatSection.style.display = 'none';
        }

        updateStatus('Отключен', 'disconnected');
    </script>
</body>
</html>
