<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P –ß–∞—Ç —Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ–º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        #onlineUsers {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        #usersList {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .user-card {
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid #007bff;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-avatar {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        .user-online {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .user-you {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        #setup {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #c8e6c9;
        }
        input, button {
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        input {
            width: calc(100% - 24px);
            background: white;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #chatSection {
            display: none;
        }
        #chat {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .my-message {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .their-message {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .message-sender {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .message-time {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }
        #messageInput {
            width: calc(100% - 100px);
            display: inline-block;
        }
        #sendButton {
            width: 90px;
            display: inline-block;
            margin-left: 10px;
        }
        .status {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
        #connectionInfo {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>üì± P2P –ß–∞—Ç —Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ–º</h1>
        
        <div id="onlineUsers">
            <h3>üë• –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: <span id="usersCount">0</span></h3>
            <div id="usersList">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <div id="setup">
            <h3>üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <input type="text" id="userName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
            <div style="display: flex; gap: 10px;">
                <button onclick="hostRoom()">üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                <button onclick="joinRoom()">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            <div id="roomCodeSection" style="display: none; margin-top: 15px;">
                <input type="text" id="roomCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
                <button onclick="connectToRoom()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            <div id="connectionInfo">
                üí° <strong>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</strong> –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –¥—Ä—É–≥—É
            </div>
        </div>
        
        <div id="chatSection">
            <div class="status" id="chatStatus">–ß–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω</div>
            <div id="chat"></div>
            <div>
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button id="sendButton" onclick="sendMessage()" disabled>üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <button onclick="leaveRoom()" style="background: #dc3545; margin-top: 10px;">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userName = '';
        let userId = '';
        let roomCode = '';
        let isHost = false;
        let connections = new Map(); // userId -> connection
        let users = new Map(); // userId -> user data
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const usersList = document.getElementById('usersList');
        const usersCount = document.getElementById('usersCount');
        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userNameInput = document.getElementById('userName');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const roomCodeSection = document.getElementById('roomCodeSection');
        const setupDiv = document.getElementById('setup');
        const chatSection = document.getElementById('chatSection');
        const chatStatus = document.getElementById('chatStatus');

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersList() {
            usersList.innerHTML = '';
            usersCount.textContent = users.size;
            
            users.forEach((userData, id) => {
                const userCard = document.createElement('div');
                userCard.className = `user-card ${id === userId ? 'user-you' : ''}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = userData.name ? userData.name[0].toUpperCase() : '?';
                
                const name = document.createElement('span');
                name.textContent = userData.name || '–ê–Ω–æ–Ω–∏–º';
                if (id === userId) name.textContent += ' (–í—ã)';
                
                const onlineDot = document.createElement('div');
                onlineDot.className = 'user-online';
                
                userCard.appendChild(avatar);
                userCard.appendChild(name);
                userCard.appendChild(onlineDot);
                usersList.appendChild(userCard);
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function addUser(id, name, connection = null) {
            users.set(id, { name, connection });
            if (connection) connections.set(id, connection);
            updateUsersList();
            addSystemMessage(`${name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function removeUser(id) {
            const user = users.get(id);
            if (user) {
                addSystemMessage(`${user.name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`);
            }
            users.delete(id);
            connections.delete(id);
            updateUsersList();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function hostRoom() {
            const name = userNameInput.value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            userName = name;
            userId = generateUserId();
            roomCode = generateRoomCode();
            isHost = true;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫
            addUser(userId, userName);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã
            showRoomCode();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —á–∞—Ç
            setupChat();
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            startListening();
            
            chatStatus.textContent = `–í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É. –ö–æ–¥: ${roomCode}`;
            chatStatus.className = 'status online';
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function joinRoom() {
            const name = userNameInput.value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            userName = name;
            userId = generateUserId();
            roomCodeSection.style.display = 'block';
            userNameInput.disabled = true;
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function connectToRoom() {
            const code = roomCodeInput.value.trim().toUpperCase();
            if (!code) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            
            roomCode = code;
            isHost = false;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫
            addUser(userId, userName);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —á–∞—Ç
            setupChat();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ö–æ—Å—Ç—É
            connectToHost();
            
            chatStatus.textContent = `–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomCode}...`;
            chatStatus.className = 'status connecting';
        }

        // –ü–æ–∫–∞–∑ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function showRoomCode() {
            setupDiv.innerHTML = `
                <h3>üéÆ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!</h3>
                <div style="text-align: center; padding: 20px; background: white; border-radius: 10px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥—É:</div>
                    <div style="font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #667eea; margin: 20px 0;">
                        ${roomCode}
                    </div>
                    <button onclick="copyRoomCode()" style="background: #28a745;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                </div>
                <div id="connectionInfo">
                    ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...
                </div>
            `;
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode)
                .then(() => alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = roomCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.');
                });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Ç–∞
        function setupChat() {
            setupDiv.style.display = 'none';
            chatSection.style.display = 'block';
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // –ù–∞—á–∞–ª–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        function startListening() {
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π WebSocket –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ P2P
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã WebRTC —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ localStorage –¥–ª—è "–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è"
            const rooms = JSON.parse(localStorage.getItem('p2p_chat_rooms') || '{}');
            rooms[roomCode] = {
                hostId: userId,
                hostName: userName,
                timestamp: Date.now(),
                users: Array.from(users.keys())
            };
            localStorage.setItem('p2p_chat_rooms', JSON.stringify(rooms));
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
            setInterval(() => {
                const rooms = JSON.parse(localStorage.getItem('p2p_chat_rooms') || '{}');
                if (rooms[roomCode]) {
                    rooms[roomCode].timestamp = Date.now();
                    rooms[roomCode].users = Array.from(users.keys());
                    localStorage.setItem('p2p_chat_rooms', JSON.stringify(rooms));
                }
            }, 2000);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            setInterval(checkOtherRooms, 3000);
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö–æ—Å—Ç—É
        function connectToHost() {
            // –ò—â–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ localStorage
            const rooms = JSON.parse(localStorage.getItem('p2p_chat_rooms') || '{}');
            const room = rooms[roomCode];
            
            if (room) {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö–æ—Å—Ç—É
                setTimeout(() => {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ —Ö–æ—Å—Ç—É
                    broadcastMessage({
                        type: 'user_join',
                        userId: userId,
                        userName: userName
                    });
                    
                    chatStatus.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomCode}`;
                    chatStatus.className = 'status online';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–æ—Å—Ç–µ
                    if (!users.has(room.hostId) && room.hostId !== userId) {
                        addUser(room.hostId, room.hostName);
                    }
                }, 1000);
            } else {
                alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã.');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–º–Ω–∞—Ç
        function checkOtherRooms() {
            const rooms = JSON.parse(localStorage.getItem('p2p_chat_rooms') || '{}');
            const now = Date.now();
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–º–Ω–∞—Ç—ã (–±–æ–ª—å—à–µ 10 —Å–µ–∫—É–Ω–¥)
            Object.keys(rooms).forEach(code => {
                if (now - rooms[code].timestamp > 10000) {
                    delete rooms[code];
                }
            });
            
            localStorage.setItem('p2p_chat_rooms', JSON.stringify(rooms));
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            const message = {
                type: 'chat_message',
                userId: userId,
                userName: userName,
                text: text,
                timestamp: Date.now()
            };
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            displayMessage(message, true);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–º
            broadcastMessage(message);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
        }

        // –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function broadcastMessage(message) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è "—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏"
            const messages = JSON.parse(localStorage.getItem(`chat_messages_${roomCode}`) || '[]');
            messages.push(message);
            localStorage.setItem(`chat_messages_${roomCode}`, JSON.stringify(messages));
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            if (messages.length > 100) {
                messages.splice(0, messages.length - 100);
                localStorage.setItem(`chat_messages_${roomCode}`, JSON.stringify(messages));
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function checkMessages() {
            const messages = JSON.parse(localStorage.getItem(`chat_messages_${roomCode}`) || '[]');
            
            messages.forEach(msg => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏ –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const messageId = `${msg.userId}_${msg.timestamp}`;
                if (!document.getElementById(messageId) && msg.userId !== userId) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (msg.type === 'chat_message') {
                        displayMessage(msg, false);
                    } else if (msg.type === 'user_join') {
                        if (!users.has(msg.userId)) {
                            addUser(msg.userId, msg.userName);
                        }
                    }
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ
                    const element = document.createElement('div');
                    element.id = messageId;
                    document.body.appendChild(element);
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message, isMy) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isMy ? 'my-message' : 'their-message'}`;
            messageDiv.id = `${message.userId}_${message.timestamp}`;
            
            if (!isMy) {
                const sender = document.createElement('div');
                sender.className = 'message-sender';
                sender.textContent = message.userName;
                messageDiv.appendChild(sender);
            }
            
            const text = document.createElement('div');
            text.textContent = message.text;
            messageDiv.appendChild(text);
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(time);
            
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addSystemMessage(text) {
            const systemDiv = document.createElement('div');
            systemDiv.style.textAlign = 'center';
            systemDiv.style.color = '#666';
            systemDiv.style.fontStyle = 'italic';
            systemDiv.style.margin = '10px 0';
            systemDiv.style.padding = '8px';
            systemDiv.style.background = '#f8f9fa';
            systemDiv.style.borderRadius = '5px';
            systemDiv.textContent = text;
            chatDiv.appendChild(systemDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
        function leaveRoom() {
            // –£–¥–∞–ª—è–µ–º —Å–µ–±—è –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
            const rooms = JSON.parse(localStorage.getItem('p2p_chat_rooms') || '{}');
            if (rooms[roomCode]) {
                rooms[roomCode].users = rooms[roomCode].users.filter(id => id !== userId);
                if (rooms[roomCode].users.length === 0) {
                    delete rooms[roomCode];
                }
                localStorage.setItem('p2p_chat_rooms', JSON.stringify(rooms));
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ
            broadcastMessage({
                type: 'user_leave',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            resetChat();
        }

        // –°–±—Ä–æ—Å —á–∞—Ç–∞
        function resetChat() {
            users.clear();
            connections.clear();
            roomCode = '';
            isHost = false;
            
            chatSection.style.display = 'none';
            setupDiv.style.display = 'block';
            roomCodeSection.style.display = 'none';
            userNameInput.disabled = false;
            userNameInput.value = '';
            chatDiv.innerHTML = '';
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            usersList.innerHTML = '';
            usersCount.textContent = '0';
        }

        // –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã
        function init() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–º–µ–Ω–∏ –≤ localStorage
            const savedName = localStorage.getItem('chat_user_name');
            if (savedName) {
                userNameInput.value = savedName;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            userNameInput.addEventListener('input', () => {
                localStorage.setItem('chat_user_name', userNameInput.value);
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ Enter
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            setInterval(checkMessages, 1000);
            setInterval(checkOtherRooms, 2000);
            
            addSystemMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π.');
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = init;
    </script>
</body>
</html>
