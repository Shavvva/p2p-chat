<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat 2025</title>
    <style>
        :root { --bg: #0f0f10; --side: #18191a; --acc: #00d2ff; --txt: #e4e6eb; --brd: #2f3031; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--txt); height: 100vh; display: flex; overflow: hidden; }
        
        #login-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: var(--side); padding: 30px; border-radius: 15px; border: 1px solid var(--brd); text-align: center; }
        
        .app { display: none; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--side); border-right: 1px solid var(--brd); display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #1c1c1e; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .in { align-self: flex-start; background: #3a3b3c; }
        .out { align-self: flex-end; background: var(--acc); color: #000; }
        
        .input-panel { padding: 15px; background: var(--side); display: flex; gap: 10px; border-top: 1px solid var(--brd); }
        input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--brd); background: #000; color: #fff; outline: none; }
        button { padding: 10px 20px; border-radius: 8px; border: none; background: var(--acc); cursor: pointer; font-weight: bold; }
        
        .user-item { padding: 10px; margin: 5px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 13px; }
        
        @media (max-width: 600px) { .sidebar { display: none; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h3>Чат 2025</h3><br>
        <input type="text" id="nick" placeholder="Ваш ник...">
        <button id="btn-login">Войти</button>
    </div>
</div>

<div class="app" id="app">
    <aside class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid var(--brd)">Онлайн: <span id="count">0</span></div>
        <div id="user-list"></div>
    </aside>
    <main class="chat-area">
        <div id="messages"></div>
        <form class="input-panel" id="chat-form">
            <input type="text" id="m-text" placeholder="Сообщение..." required>
            <button type="submit">➤</button>
        </form>
    </main>
</div>

<script type="module">
    import { initializeApp } from "www.gstatic.com";
    import { getDatabase, ref, push, onValue, set, onDisconnect, serverTimestamp } from "www.gstatic.com";

    const conf = { databaseURL: "chat-c54e2-default-rtdb.europe-west1.firebasedatabase.app" };
    const app = initializeApp(conf);
    const db = getDatabase(app);
    
    let user = "";
    const myId = Math.random().toString(36).substring(7);

    // Логин
    document.getElementById('btn-login').onclick = () => {
        user = document.getElementById('nick').value.trim();
        if(!user) return alert("Введите ник");
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        initChat();
    };

    function initChat() {
        // 1. Сообщения
        onValue(ref(db, 'msgs'), (snap) => {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            snap.forEach((child) => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = `msg ${m.u === user ? 'out' : 'in'}`;
                div.innerHTML = `<small style="display:block;opacity:0.6">${m.u}</small>${m.t}`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });

        // 2. Статус Онлайн
        const statusRef = ref(db, `online/${myId}`);
        set(statusRef, { name: user });
        onDisconnect(statusRef).remove();

        onValue(ref(db, 'online'), (snap) => {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            let c = 0;
            snap.forEach((child) => {
                c++;
                const u = child.val();
                list.innerHTML += `<div class="user-item">● ${u.name}</div>`;
            });
            document.getElementById('count').innerText = c;
        });
    }

    // Отправка
    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('m-text');
        push(ref(db, 'msgs'), { u: user, t: input.value, ts: serverTimestamp() });
        input.value = '';
    };
</script>
</body>
</html>
